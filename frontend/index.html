<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Venta de Productos</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">


</head>
<body>

  <div class="container">
    <h1 class="my-4 text-center">Stock en Sucursales</h1>

    <!-- Opci贸n para seleccionar la moneda (CLP o USD) -->
    <div class="mb-3">
      <label for="moneda" class="form-label">Seleccionar moneda:</label>
      <select id="moneda" class="form-select">
        <option value="CLP">CLP (Peso Chileno)</option>
        <option value="USD">USD (D贸lar Estadounidense)</option>
      </select>
    </div>

    <div id="stock-list" class="mb-4"></div>

    <h2>Realizar Venta</h2>
    <!-- Formulario para la venta -->
    <div class="mb-3">
      <label for="sucursal" class="form-label">Sucursal:</label>
      <select id="sucursal" class="form-select"></select>
    </div>

    <div class="mb-3">
      <label for="cantidad" class="form-label">Cantidad:</label>
      <input type="number" id="cantidad" class="form-control" />
    </div>

    <button onclick="vender()" class="btn btn-primary">Vender</button>

    <p id="respuesta" class="mt-3"></p>
  </div>

  <!-- Agregar el script de Bootstrap -->
  <script src="js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

  <!-- El script JavaScript directamente en el archivo HTML -->
  <script>
    let stockData = {};
    const API_KEY = '4b8e617ac83d1846e0c0db3f'; // Reemplaza con tu clave API

    // Funci贸n para obtener la tasa de cambio
    function obtenerTasaCambio(moneda) {
      return fetch(`https://v6.exchangerate-api.com/v6/${API_KEY}/latest/${moneda}`)
        .then(res => res.json())
        .then(data => {
          if (moneda === "CLP") {
            return data.conversion_rates.USD;  // Tasa de CLP a USD
          } else {
            return data.conversion_rates.CLP;  // Tasa de USD a CLP
          }
        })
        .catch(error => {
          console.error("Error al obtener la tasa de cambio:", error);
          return 1;  // Si hay error, consideramos la tasa como 1 (sin conversi贸n)
        });
    }

    // Cargar el stock desde el backend
    fetch('http://localhost:8000/stock/')
      .then(res => res.json())
      .then(data => {
        stockData = data;
        const lista = document.getElementById("stock-list");
        const selector = document.getElementById("sucursal");

        // Cargar las sucursales y el stock
        for (const sucursal in data) {
          const info = data[sucursal];
          lista.innerHTML += `<div class="producto">
            <h5>${sucursal.toUpperCase()}</h5>
            <p><strong>Stock:</strong> ${info.cantidad}</p>
            <p><strong>Precio:</strong> $${info.precio}</p>
          </div>`;
          selector.innerHTML += `<option value="${sucursal}">${sucursal.toUpperCase()}</option>`;
        }
      });

    function vender() {
      const sucursal = document.getElementById("sucursal").value;
      const cantidad = parseInt(document.getElementById("cantidad").value);
      const stockDisponible = stockData[sucursal].cantidad;
      const monedaSeleccionada = document.getElementById("moneda").value;
      const precioOriginal = stockData[sucursal].precio;

      // Obtener tasa de cambio para la moneda seleccionada
      obtenerTasaCambio(monedaSeleccionada).then(tasa => {
        let precioConvertido = precioOriginal;

        // Si la moneda es USD, convertir el precio
        if (monedaSeleccionada === 'USD') {
          precioConvertido = precioOriginal / tasa;  // Convertir de CLP a USD
        } else {
          precioConvertido = precioOriginal * tasa;  // Convertir de USD a CLP
        }

        // Mostrar el precio convertido
        const precioFinal = precioConvertido.toFixed(2);

        if (cantidad > stockDisponible) {
          document.getElementById("respuesta").innerText = "No hay suficiente stock.";
          document.getElementById("respuesta").classList.add("text-danger");
          document.getElementById("respuesta").classList.remove("text-success");
        } else {
          document.getElementById("respuesta").innerText = `Venta realizada en ${sucursal.toUpperCase()} por ${cantidad} unidades. Precio total: ${precioFinal} ${monedaSeleccionada}`;
          document.getElementById("respuesta").classList.add("text-success");
          document.getElementById("respuesta").classList.remove("text-danger");
        }
      });
    }
  </script>

</body>
</html>
